# PR from any branch -> into main, dev, or sandbox: playwright runs on the PR
# Direct push to main, dev, or sandbox: playwright runs on that push too
# Builds frontend to prevent merging code that passes tests but fails production build
name: Playwright E2E Tests

on:
  push:
    branches: [main, dev, sandbox, uiTesting/playwright/saanya]
  pull_request:
    branches: [main, dev, sandbox]

jobs:
  test:
    runs-on: ubuntu-latest

    # 1) MySQL service for TEST DB
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: mysql2025
          MYSQL_DATABASE: salon_app_test
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h 127.0.0.1 -uroot -pmysql2025"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      # 2) Checkout FRONTEND repo (this one)
      - uses: actions/checkout@v4
        with:
          path: frontend

      # 3) Checkout BACKEND repo
      - uses: actions/checkout@v4
        with:
          repository: BarkStrip/CS490-Group-5-Backend
          path: backend

      # 4) Set up Python for backend
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 5) Install backend deps & initialize TEST DB schema
      - name: Install backend dependencies
        working-directory: backend
        run: |
          pip install -r requirements.txt

      - name: Initialize test database schema + seed Playwright data
        working-directory: backend
        env:
          # Use the SAME creds as the MySQL service above
          SQLALCHEMY_DATABASE_URI: mysql+pymysql://root:mysql2025@127.0.0.1:3306/salon_app_test
          MYSQL_PUBLIC_URL: mysql+pymysql://root:mysql2025@127.0.0.1:3306/salon_app_test
          MYSQL_TEST_URL: mysql+pymysql://root:mysql2025@127.0.0.1:3306/salon_app_test
          TESTING: "True"
          PORT: "5000"
        run: |
          echo "ðŸ“¦ Creating tables using Base.metadata and seeding Playwright users..."
          python - << 'EOF'
          import os, sys
          sys.path.append(os.getcwd())

          from main import create_app
          from app.extensions import db
          from app.models import Base
          from tests.seed_playwright_data import seed_playwright_users

          app = create_app()

          with app.app_context():
              print("Dropping all tables in test DB...")
              Base.metadata.drop_all(bind=db.engine)
              print("Creating all tables in test DB...")
              Base.metadata.create_all(bind=db.engine)
              print("Seeding Playwright fixtures...")
              seed_playwright_users()
              print("âœ… Schema initialized and seed data inserted.")
          EOF

      # 6) Run backend in TESTING mode
      - name: Run backend (testing mode)
        working-directory: backend
        env:
          FLASK_ENV: testing
          TESTING: "True"
          MYSQL_TEST_URL: mysql+pymysql://root:mysql2025@127.0.0.1:3306/salon_app_test
          MYSQL_PUBLIC_URL: mysql+pymysql://root:mysql2025@127.0.0.1:3306/salon_app_test
          PORT: "5000"
        run: |
          flask run --host=0.0.0.0 --port=5000 &
          # small delay to let backend start up
          sleep 10

      # 7) Set up Node for frontend
      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install frontend deps
        working-directory: frontend
        run: npm ci

      - name: Build frontend
        working-directory: frontend
        env:
          # IMPORTANT: point frontend to local backend, NOT Railway
          VITE_API_URL: http://localhost:5000
        run: npm run build

      - name: Install Playwright
        working-directory: frontend
        run: npx playwright install --with-deps

      # 8) Run Playwright E2E tests against local backend + test DB
      - name: Run Playwright
        working-directory: frontend
        env:
          VITE_API_URL: http://localhost:5000
        run: npx playwright test

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: frontend/playwright-report
